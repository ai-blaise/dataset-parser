#!/usr/bin/env python3
"""Generate before/after rerollout comparison"""
import json
import requests

API = "http://localhost:30000/v1/chat/completions"
MODEL = "deepseek-ai/DeepSeek-V3.2"

# Load first record
with open("parsed_datasets/interactive_agent_parsed.jsonl") as f:
    original = json.loads(f.readline())

# Build rerolled version
messages = original["messages"]
tools = original["tools"]
context = []
rerolled_messages = []

for msg in messages:
    if msg["role"] == "assistant":
        # Call model to regenerate
        payload = {
            "model": MODEL,
            "messages": context,
            "tools": tools,
            "max_tokens": 1024,
            "temperature": 0.7
        }
        resp = requests.post(API, json=payload, timeout=120)
        new_msg = resp.json()["choices"][0]["message"]
        
        # Clean up the message
        clean_msg = {"role": "assistant", "content": new_msg.get("content", "")}
        if new_msg.get("tool_calls"):
            clean_msg["tool_calls"] = new_msg["tool_calls"]
        
        context.append(clean_msg)
        rerolled_messages.append(clean_msg)
    else:
        # Keep system/user/tool as-is
        clean_msg = {"role": msg["role"], "content": msg.get("content", "")}
        if msg.get("tool_call_id"):
            clean_msg["tool_call_id"] = msg["tool_call_id"]
        context.append(clean_msg)
        rerolled_messages.append(clean_msg)

rerolled = {
    "uuid": original["uuid"],
    "messages": rerolled_messages,
    "tools": tools,
    "license": original.get("license"),
    "used_in": original.get("used_in", [])
}

# Write comparison file
output = {
    "description": "Rerollout Proof: Before and After comparison",
    "model_used": MODEL,
    "record_uuid": original["uuid"],
    "BEFORE (original parsed - assistant content stripped)": original,
    "AFTER (rerolled - assistant responses regenerated by model)": rerolled
}

with open("rerollout_proof.json", "w") as f:
    json.dump(output, f, indent=2)

print("Written to rerollout_proof.json")
