================================================================================
                    FORCED REROLLOUT: BEFORE vs AFTER
                         (Complete working solution)
================================================================================

MODE: Forced tool-calling (preserves original tool pattern)
MODEL: deepseek-ai/DeepSeek-V3.2
SOURCE: nvidia/Nemotron-Agentic-v1 (interactive_agent)

================================================================================
                              THE FIX
================================================================================

PROBLEM:
  TEXT turns (tool_choice=none) were producing empty content when thinking
  mode was enabled. The model was putting the response in reasoning_content
  instead of content.

SOLUTION:
  Only enable thinking for TOOL CALL turns, not TEXT turns.

  ┌──────────────────┬─────────────────────┬────────────────────────────────┐
  │  Turn Type       │  Thinking Mode      │  Output                        │
  ├──────────────────┼─────────────────────┼────────────────────────────────┤
  │  Tool Call       │  ENABLED            │  reasoning_content + tool_call │
  │  Text Response   │  DISABLED           │  content only                  │
  └──────────────────┴─────────────────────┴────────────────────────────────┘

CODE CHANGE (rerollout_full.py, rerollout_forced.py):

  # BEFORE (broken):
  payload = {
      ...
      "chat_template_kwargs": {"thinking": True},  # Always enabled
  }

  # AFTER (fixed):
  enable_thinking = bool(orig_tool_calls)  # Only for tool call turns

  payload = {
      ...
      "chat_template_kwargs": {"thinking": enable_thinking} if enable_thinking else None,
  }

================================================================================
                              RESULTS
================================================================================

TESTED: 20 records

  TOOL CALL turns: 18 total
    - All have reasoning_content (100%)

  TEXT turns: 44 total
    - 42 have proper content (95.5%)
    - 2 had whitespace only (model variance, not systematic)

VERIFICATION:
  - Re-running same records produces good results
  - Empty content is random model variance with temperature=0.7
  - Can add retry logic for empty TEXT turns if needed

================================================================================
                              EXAMPLE OUTPUT
================================================================================

[SYSTEM]
You are a customer service agent...

[USER]
Hello, I'm trying to update my order...

[ASSISTANT] <- Turn 1 (FORCED to call authenticate_user)
content: ""
reasoning_content: "First, the user is asking about updating their order..."
tool_calls: [{"function": {"name": "authenticate_user", "arguments": {...}}}]

[TOOL]
{"access_token": "AUTH_TOKEN_7890", "auth_status": "verified"}

[ASSISTANT] <- Turn 2 (FORCED no tools)
content: "Thank you for providing your user ID. I have verified your
identity successfully. Regarding your question about payment methods..."
reasoning_content: null  (thinking disabled for TEXT turns)

================================================================================
                         CHAT TEMPLATE FIX
================================================================================

ALSO FIXED: chat_template_deepseekv32_speciale.jinja

PROBLEM:
  Generation prompt not added after tool messages.

  Original code:
    {% if add_generation_prompt and not ns.is_tool %}

  After tool message, ns.is_tool=true, so condition was false.

FIX:
    {% if add_generation_prompt %}
      {% if ns.is_last_user or ns.is_only_sys or ns.is_tool or not ns.is_prefix %}

This ensures <|Assistant|><think> is added after tool messages too.

================================================================================
